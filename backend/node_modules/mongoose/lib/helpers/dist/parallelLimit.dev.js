'use strict';

module.exports = parallelLimit;
/*!
 * ignore
 */

function parallelLimit(fns, limit, callback) {
  var numInProgress = 0;
  var numFinished = 0;
  var error = null;

  if (limit <= 0) {
    throw new Error('Limit must be positive');
  }

  if (fns.length === 0) {
    return callback(null, []);
  }

  for (var i = 0; i < fns.length && i < limit; ++i) {
    _start();
  }

  function _start() {
    fns[numFinished + numInProgress](_done(numFinished + numInProgress));
    ++numInProgress;
  }

  var results = [];

  function _done(index) {
    return function (err, res) {
      --numInProgress;
      ++numFinished;

      if (error != null) {
        return;
      }

      if (err != null) {
        error = err;
        return callback(error);
      }

      results[index] = res;

      if (numFinished === fns.length) {
        return callback(null, results);
      } else if (numFinished + numInProgress < fns.length) {
        _start();
      }
    };
  }
}